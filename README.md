# psql

Это подсистема [Skuapso](http://github.com/skuapso/skuapso)

**На данный момент находится в разработке и не является стабильной**

## Зависимости
* [postgresql](http://www.postgresql.org), версия не ниже 9.4

*следующие зависимости используются в разрабатываемой части и не используются в стабильной*
* [jsonb-extend](http://github.com/koctep/jsonb-extend)
* [postgis](http://postgis.net)

## Предназначение

Хранение и обработка данных навигационных терминалов.

Запросы в данном приложении используют пул рабочих и очередь запросов с приоритетом

## Сборка
### Erlang-приложение
собирается в [skuapso](http://github.com/skuapso/skuapso)
### Подготовка БД
* создать отдельного пользователя (строго рекомендуется использовать отдельного пользователя, рекомендуемое имя - skuapso)
* необходимо создать БД (строго рекомендуется использовать отдельную БД, рекомендуемое имя - skuapso) указав владельцем пользователя из предыдущего пункта

Вот как это делается от пользователя-создателя кластера postgresql (обычно - postgres):
```bash
$ createuser -E -P skuapso
$ createdb -O skuapso skuapso
```
Проверьте что пользователь может подключиться к БД:
```bash
$ psql -H 127.0.0.1 -U skuapso skuapso
```
Если не получилось -- обратитесь к документации postgresql. [Предполагаемый мануал](http://www.postgresql.org/docs/9.4/static/auth-pg-hba-conf.html). Учтите что подключение идет через tcp-сокет.

Для упращения инициализации БД я добавляю в pg_hba.conf следующую строку:

```local skuapso skuapso trust```

Само приложение работает через tcp-сокет, unix-сокет используется только для инициализации БД.

Есть альтернативные способы:
* http://www.postgresql.org/docs/9.4/static/libpq-pgpass.html
* использовать ident вместо trust (настроить маппинг, либо создать отдельного пользователя в системе)

### Инициализация БД
Из директории [skuapso](http://github.com/skuapso/skuapso)
```bash
$ cd lib/psql/sql
```
Если вы изменили рекомендуемые имена для базы данных/пользователя, необходимо отредактировать файл `Makefile.config`

```bash
$ make install
```

## Конфигурация
```erlang
[
 {psql,[{host,"localhost"},         % на каком хосте располагается БД
        {port,5432},                % порт
        {database,"skuapso"},       % имя базы данных
        {user,"skuapso"},           % имя пользователя
        {password,""},              % пароль
        {max_connections,20},       % максимальное количество соединений
        {queue_size, unlimited},    % размер очереди невыполненных запросов
        {weight,1},                 % с каким весом будут установлены хуки, не рекомендуется для изменения
        {pre_commands,[]}]}         % перед каждым запросом будут выполнены данные запросы,
                                    % запросы должны возвращать true/false,
                                    % если возвращается false - запрос не выполняется
].
```
